#!/bin/bash
SCRIPTPATH=$(dirname $(realpath $0))

LIST="192.168.100.110 192.168.100.111 192.168.100.11 192.168.100.112 192.168.100.113 192.168.100.114 192.168.100.115 192.168.100.116 192.168.100.117 192.168.100.118 192.168.100.130 192.168.100.140 192.168.100.150 192.168.100.151 192.168.100.152 192.168.100.153 192.168.100.154 192.168.100.170 192.168.100.171 192.168.100.172 192.168.100.173 192.168.100.174 192.168.100.175"

BUILD=$(printf "[")
for i in $LIST
 do
 RESPONSE=$(printf "{\"HOST\":\"$i\",\""; $SCRIPTPATH/api.pl -c summary -a $i -p 4068 | tr -d '\0' | sed -r 's/=/":"/g; s/;/\",\"/g' | sed 's/|/",/g')$(printf "\""; $SCRIPTPATH/api.pl -c pool -a $i -p 4068 | tr -d '\0' | sed -r 's/=/":"/g' | sed -r 's/;/\",\"/g' | sed 's/|/"},/g')
 if [[ "$RESPONSE" == *"No Connect"* ]]
 then
  BUILD=$BUILD"{\"HOST\":\"$i\"},"
 else
  BUILD=$BUILD$RESPONSE
 fi
done
JSON=$(echo $BUILD | tr -d '\r\n' | sed "s/.\{0,2\}$//; /^$/d"; printf "}]")
echo $JSON | jq '[.[] | {HOST,POOL,USER,KHS,DIFF,ACC,REJ,WAIT,UPTIME,TS}]'
